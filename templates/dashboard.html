{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <input type="hidden" id="portfolio-data" value='[{% for h in portfolio %}{"symbol":"{{ h.symbol }}","units":{{ h.total_units }},"investment":{{ h.total_investment }}}{% if not loop.last %},{% endif %}{% endfor %}]'>
    
    <script>
    function updatePrices() {
        console.log('Fetching updated prices...');
        fetch('/api/prices')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received price data:', data);
                if (!data.success) {
                    console.warn('API returned success: false', data.message);
                    return;
                }
                
                // Parse portfolio data once
                const portfolioData = JSON.parse(document.getElementById('portfolio-data').value);

                Object.entries(data.prices).forEach(([symbol, cryptoData]) => {
                    // Update price
                    const priceElement = document.getElementById(`price-${symbol}`);
                    if (priceElement) {
                        const oldPrice = parseFloat(priceElement.textContent.replace('$', ''));
                        const newPrice = parseFloat(cryptoData.price);
                        const priceChange = newPrice - oldPrice;
                        const percentChange = (priceChange / oldPrice) * 100;
                        
                        console.log(`${symbol} Price Update:
                            Old Price: $${oldPrice.toFixed(2)}
                            New Price: $${newPrice.toFixed(2)}
                            Change: ${priceChange > 0 ? '+' : ''}$${priceChange.toFixed(2)} (${percentChange.toFixed(2)}%)
                            Last API Update: ${cryptoData.last_updated}
                        `);
                        
                        // Add visual feedback for price changes
                        const changeClass = priceChange > 0 ? 'text-green-600' : priceChange < 0 ? 'text-red-600' : '';
                        priceElement.textContent = `$${newPrice.toFixed(2)}`;
                        priceElement.className = `text-sm text-gray-900 ${changeClass}`;
                        
                        // Make the change more visible
                        if (priceChange !== 0) {
                            priceElement.style.transition = 'all 0.3s ease';
                            priceElement.style.backgroundColor = priceChange > 0 ? 'rgba(0, 255, 0, 0.1)' : 'rgba(255, 0, 0, 0.1)';
                            
                            // Revert the color after 1 second
                            setTimeout(() => {
                                priceElement.className = 'text-sm text-gray-900';
                                priceElement.style.backgroundColor = '';
                            }, 1000);
                        }
                        
                        // Find holding data
                        const holding = portfolioData.find(h => h.symbol === symbol);
                        if (holding) {
                            const units = holding.units;
                            const investment = holding.investment;
                            
                            // Update current value
                            const valueElement = document.getElementById(`value-${symbol}`);
                            if (valueElement) {
                                const currentValue = units * newPrice;
                                valueElement.textContent = `$${currentValue.toFixed(2)}`;
                                
                                // Update profit/loss
                                const plElement = document.getElementById(`pl-${symbol}`);
                                if (plElement) {
                                    const profitLoss = currentValue - investment;
                                    const plPercentage = (profitLoss / investment) * 100;
                                    plElement.textContent = `$${profitLoss.toFixed(2)} (${plPercentage.toFixed(1)}%)`;
                                    plElement.className = `text-sm ${profitLoss >= 0 ? 'text-green-600' : 'text-red-600'}`;
                                }
                            }
                        }
                    }
                    
                    // Update last updated time
                    const updatedElement = document.getElementById(`updated-${symbol}`);
                    if (updatedElement) {
                        const now = new Date();
                        updatedElement.textContent = `Last updated: ${now.toLocaleTimeString()}`;
                    }
                });
            })
            .catch(error => console.error('Error updating prices:', error));
    }

    // Start updates when page loads
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Starting price updates...');
        updatePrices();  // Initial update
        
        // Update every 30 seconds to respect rate limits
        // CoinGecko's free API has a rate limit of 10-30 calls per minute
        setInterval(() => {
            console.log('Scheduled price update...');
            updatePrices();
        }, 30000);
    });
    </script>

    <h2 class="text-2xl font-bold mb-4 text-primary-900">Portfolio Dashboard</h2>
    
    <!-- Portfolio Summary -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-8">
        <h3 class="text-lg sm:text-xl font-semibold mb-4 text-primary-800">Your Portfolio</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-primary-50">
                    <tr>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Cryptocurrency</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Holdings</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Current Price</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Current Value</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Profit/Loss</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for holding in portfolio %}
                    <tr id="holding-{{ holding.symbol }}">
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ holding.symbol }}</div>
                            <div class="text-sm text-gray-500">{{ holding.name }}</div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ "%.4f"|format(holding.total_units) }}</div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900" id="price-{{ holding.symbol }}">${{ "%.2f"|format(holding.current_price) }}</div>
                            <div class="text-xs text-gray-500" id="updated-{{ holding.symbol }}">Updating...</div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900" id="value-{{ holding.symbol }}">${{ "%.2f"|format(holding.current_value) }}</div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="text-sm {% if holding.profit_loss >= 0 %}text-green-600{% else %}text-red-600{% endif %}" id="pl-{{ holding.symbol }}">
                                    ${{ "%.2f"|format(holding.profit_loss) }} ({{ "%.1f"|format(holding.profit_loss_percentage) }}%)
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
        <h3 class="text-lg sm:text-xl font-semibold mb-4 text-primary-800">Recent Transactions</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-primary-50">
                    <tr>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Date</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Type</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Cryptocurrency</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Amount</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Units</th>
                        <th class="px-4 sm:px-6 py-3 text-left text-xs font-medium text-primary-800 uppercase tracking-wider">Price</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for transaction in transactions %}
                    <tr>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ transaction.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {% if transaction.transaction_type == 'buy' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ transaction.transaction_type.upper() }}
                            </span>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ transaction.cryptocurrency.symbol }}</div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${{ "%.2f"|format(transaction.investment_amount) }}</div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ "%.4f"|format(transaction.units) }}</div>
                        </td>
                        <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${{ "%.2f"|format(transaction.price_at_time) }}</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %} 